<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Assign Plate Labels</title>

        <!-- CSS Stuff -->
        <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
        <link rel="stylesheet" href="css/smoothness/jquery-ui.css" type="text/css"/>
        <link rel="stylesheet" href="css/Grid.css" type="text/css"/>

        <!-- demonstration.css is specific to this page, it does not affect grid, just
        general page styling, so feel free to get rid of it for other pages-->
        <link rel="stylesheet" href="css/demonstration.css" type="text/css"/>
		
        <!-- scripts -->

        <!-- library scripts, for using Slickgrid -->
        <script type="text/javascript" src="js/lib/jquery-1.11.2.js"></script>
        <script type="text/javascript" src="js/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="js/lib/jquery.event.drag-2.2.js"></script>
        <script type="text/javascript" src="js/lib/slick.core.js"></script>
        <script type="text/javascript" src="js/lib/slick.grid.js"></script>
        <script type="text/javascript" src="js/lib/slick.autotooltips.js"></script>
        <script type="text/javascript" src="js/lib/slick.cellrangedecorator.js"></script>
        <script type="text/javascript" src="js/lib/slick.cellrangeselector.js"></script>
        <script type="text/javascript" src="js/lib/slick.cellcopymanager.js"></script>
        <script type="text/javascript" src="js/lib/slick.cellselectionmodel.js"></script>
        <script type="text/javascript" src="js/lib/slick.editors.js"></script>

        <!-- The SlickGrid wrapper script -->
        <script type="text/javascript" src="js/Grid.js"></script>
    </head>
    <body>	
		<h2>Create Plate: (step 3 of 3)</h2>
		<div id="gridPanel" style="float:left; width: 70%">
			<div id="myGrid" style="width:100%;height:650px;"></div>
		</div>
		<div id="labelPanel" style="float:right;width:29%;">
			<div>Cell Range Selected:<span id="cellRange"></span></div>
			<hr/>
			<div id="tabs-1">
				<ul>
					<li><a href="#tabs-2">Well Grouping</a></li>
					<li><a href="#tabs-3">Plate</a></li>
					<li><a href="#tabs-4">Plate Set</a></li>
				</ul>
				<div id="tabs-2">
					<h1>Well Grouping Labels:</h1>
					<button id="addLabelButton" class="ui-state-default ui-corner-all">Add New Label</button>
					<button id="addDoseStepButton" class="ui-state-default ui-corner-all">Add Dose Step</button>
					<button id="importCmpListButton" class="ui-state-default ui-corner-all">Import Compound List??</button>
					
					<div class="toggler">
						<div id="addLabelPanel" class="ui-widget-content ui-corner-all">
							<h4>New Label Details:</h4>
							<div>Category:<input type="text" id="newCatValue"/></div>
							<div>Label:<input type="text" id="newLabelValue"/></div>
							<div>Color:<input type="color" id="newColorValue" value="#FFFF00"/></div>
							<hr/>
							<strong><-- Select Wells To Apply Labels To:</strong>
							<div> <button id="clearLastSelection">Undo Last Selection</button><button id="clearAllSelection">Clear Selection</button></div>
							<hr/>
							<div><button id="addNewLabel">Apply New Label</button><button id="cancelNewLabel">Cancel</button></div>
						</div>
					</div>
					
					<div id="categoryList"/>
					
				</div>
				<div id="tabs-3">
					<h1>Plate Level Labels:</h1>
					<p></p>
				</div>
				<div id="tabs-4">
					<h1>Plate Set Labels:</h1>
					<p></p>
				</div>
			</div>
		</div>
		<div id="editLabelDialog" title="New Label Name">
			<input type="text" id="editNewLabelValue"/>
		</div>
		
		
        <script type="text/javascript">
            // constants
            var DIMENSION = 100;
            var data;
			//var categories = {};	// note declaring as an object ???
			var cellCats = {};
			var catLegend = {};
            var grid;
            var currentHighlightKeys = [];
            var highlightKeyCounter = 0;
            var currentHighlightColor = "#D5E3E3";
			var highlightedCoords = [];
			
			// tmp editlabel vars
			var tmpEditOldLabel;
			var tmpEditCat;

            /**
             * A function that creates a blank data set for initializing the grid example
             * page. The data set is of dimension DIMENSION x DIMENSION.
             */
            function createBlankData(){
                var result = [];

                for (var i=0; i<DIMENSION; i++){
                    result[i] = [];
                    for (var j=0; j<DIMENSION; j++){
                        result[i][j] = null;
                    }
                }
                return result;
            }

            /**
             * A function that creates a random data set for displaying in the grid example
             * page. The data set is of dimension DIMENSION x DIMENSION.
             */
            function createRandomData(){
                var result = [];
                for (var i=0; i<DIMENSION; i++){
                    result[i] = [];
                    for (var j=0; j<DIMENSION; j++){
                        result[i][j] = "L" + Math.floor(Math.random()*100);
                    }
                }
                return result;
            }

            /**
             * A handler function for when the selected cells in the grid changes. This
             * function is registered to listen for these events in the createGrid
             * function using the registerSelectedCellsCallBack function of the Grid
             * Class. This function changes the background color of all selected cells
             * to the currentHighlightColor.
             */
            function handleSelectedCells(startRow,startCol,endRow, endCol){
                // write to the selected cells div, the cells that are selected
                var out = document.getElementById("cellRange");
                out.innerHTML = Grid.getRowLabel(startRow+1)+startCol+":"
                                +Grid.getRowLabel(endRow+1)+endCol;


                // highlight those cells with the current color
                var coordinatesToHighlight = [];
                for (var i=startRow; i<=endRow; i++){
                    for (var j=startCol; j<=endCol; j++){
                        coordinatesToHighlight.push([i, j]);
						// set global record of highlights
						highlightedCoords.push([i+1, j]);
                    }
                }
                var key = "key" + highlightKeyCounter;
                grid.setCellColors(coordinatesToHighlight,currentHighlightColor, key);
                currentHighlightKeys.push(key);
                highlightKeyCounter++;
            }
			
			/**
             * This function handles the event that the removeHighlighting button is
             * clicked by removing the most recent cell background color change. This
             * is achieved by calling the removeCellColors method of the Grid class with
             * the most key used to create the most recent background color change as
             * stored in the currentHighlightKeys array.
             */
            function removeHighlightedArea(){
				if (currentHighlightKeys.length > 0) {
					grid.removeCellColors(currentHighlightKeys.pop());
					
					// need to decrement highlightedCoords here !! 
					//(not the same number of items removed !!!)
					highlightedCoords.pop();	// need to fix !!
				}
            }

            /**
             * This function handles the event that the removeHighlighting button is
             * clicked by removing the most recent cell background color change. This
             * is achieved by calling the removeCellColors method of the Grid class with
             * the most key used to create the most recent background color change as
             * stored in the currentHighlightKeys array.
             */
            function removeAllHighlightedCells(){
				while (currentHighlightKeys.length > 0) {
					grid.removeCellColors(currentHighlightKeys.pop());
				}
				// removing all selected cells, so global count disappears
				highlightedCoords = [];
            }

            /**
             * This function creates a new grid applying it to the "myGrid" div on the
             * page. It then creates a blank data set and displays it in the grid.
             * It also registers the handleSelectedCells function as a listener for
             * the event that user selected cell ranges in the grid change.
             */
            function createGrid(){
                // construct the Grid object with the id of the html container element
                // where it should be placed (probably a div) as an argument
                grid  = new Grid("myGrid");

                // set the data to be displayed which must be in 2D array form
                data = createBlankData();
                grid.setData(data);

                // display the data
                grid.fillUpGrid();

                // register a function to be called each time a new set of cells are
                // selected by a user
                grid.registerSelectedCellCallBack(handleSelectedCells);

            }

            /**
             * This function loads random numeric data into the already created and
             * displayed Grid. It is a handler for the event that the "loadData" button
             * is clicked.
             */
            function loadRandomData(){
                data = createRandomData();
                grid.setData(data);
                grid.fillUpGrid();
            }
			
			function onCatColorChange(){
				var idArr = this.id.split("-");
				var cat = idArr[1];
				var label = idArr[2];
				updateCellColors(cat, label, this.value);	
            }
			
			function onEditLabelChange(){		// some issues here !! (when editing 1st label in cat, it actually changes 2nd !!)
				var idArr = this.id.split("-");
				tmpEditCat = idArr[1];
				tmpEditOldLabel = idArr[2];
				console.log("editLabel: "+ tmpEditCat + ";" + tmpEditOldLabel);
				$("#editLabelDialog").dialog("open");
            }
			
			function onDeleteLabelChange(){
				var idArr = this.id.split("-");
				var cat = idArr[1];
				var label = idArr[2];
				console.log("deleteLabel: "+ cat + ";" + label);
				removeLabel(cat, label)
            }
			
			function updateCellColors(cat, label, color) {
				// update all cells with cat and label (messy?)
				if (catLegend[cat] != undefined && catLegend[cat][label] != undefined) {
					for (var cellRef in catLegend[cat][label]["cellref"]) {			//change iteration method !!!
						// what are you doing here ??, define some sort of structure !!!
						var cellRefArr = catLegend[cat][label]["cellref"][cellRef].split("-");
						var row = cellRefArr[0];
						var column = cellRefArr[1];
						cellCats[row][column]["cats"][cat] = color;
						
						// update actual grid cell
						var newContents = cellCats[row][column]["value"];
						for (var catKey in cellCats[row][column]["cats"]) {
							newContents += "," + cellCats[row][column]["cats"][catKey];
						}
						grid.updateCellContents(row, column, newContents);
					}
				}
			}
			
			function createColorPicker(cat, label) {
				var cpDiv = document.createElement("span");
				var newInput = document.createElement("input");
				newInput.id = "color-" + cat + "-" + label;
				newInput.type = "color";
				newInput.defaultValue = catLegend[cat][label]['color'];
				newInput.value = catLegend[cat][label]['color'];
				//newInput.onchange = onCatColorChange;
				
				var editLabelBtn = document.createElement("input");
				editLabelBtn.id = "edit-" + cat + "-" + label;
				editLabelBtn.type = "button";
				editLabelBtn.value = "Edit Label"
				//editLabelBtn.onclick = onEditLabelChange;
				
				var deleteLabelBtn = document.createElement("input");
				deleteLabelBtn.id = "delete-" + cat + "-" + label;
				deleteLabelBtn.type = "button";
				deleteLabelBtn.value = "Delete Label"
				//deleteLabelBtn.onclick = onDeleteLabelChange;
				
				cpDiv.appendChild(newInput);
				cpDiv.appendChild(editLabelBtn);
				cpDiv.appendChild(deleteLabelBtn);
				
				return cpDiv;
			}
			
			function updateCategoryList() {
				var newDiv = document.createElement("div");
				var newH3 = document.createElement("h3");
				var h3Text = document.createTextNode('Categories:');
				newH3.appendChild(h3Text);
				newDiv.appendChild(newH3);
				for (var catKey in catLegend) {
					var newUl = document.createElement("ul");
					var newStrong = document.createElement("strong");
					newStrong.appendChild(document.createTextNode(catKey));
					newDiv.appendChild(newStrong);
					for (var labelKey in catLegend[catKey]) {
						var newLi = document.createElement("li");
						newLi.appendChild(document.createTextNode(labelKey));
						var newInput = createColorPicker(catKey, labelKey);
						newLi.appendChild(newInput);
						newUl.appendChild(newLi);
					}
					newDiv.appendChild(newUl);
				}
				document.getElementById("categoryList").innerHTML = newDiv.innerHTML;
				
				// apply events with a redundant nested loop. only seems to work when part of dom. fix!!(remove loop)
				for (var catKey in catLegend) {
					for (var labelKey in catLegend[catKey]) {
						$("#color-" + catKey + "-" + labelKey).change(onCatColorChange);
						$("#edit-" + catKey + "-" + labelKey).click(onEditLabelChange);
						$("#delete-" + catKey + "-" + labelKey).click(onDeleteLabelChange);
					}
				}
			}
			
			function enableGridSelection() {
				removeAllHighlightedCells();
				grid.enableCellSelection();
			}
			
			function disableGridSelection() {
				removeAllHighlightedCells();
				grid.disableCellSelection();
			}
			
			function cancelNewLabel() {
				hideLabelPanel();
			}

			// remove and cleanup references to cat and label
			function removeLabel(cat, label) {
				delete catLegend[cat][label]['color'];
				
				// remove all cells with cat and label (messy?)
				for (var cellRef in catLegend[cat][label]["cellref"]) {			//change iteration method !!!
					// what are you doing here ??, define some sort of structure !!!
					var cellRefArr = catLegend[cat][label]["cellref"][cellRef].split("-");
					var row = cellRefArr[0];
					var column = cellRefArr[1];

					delete cellCats[row][column]["cats"][cat];
					
					// update actual grid cell
					var newContents = cellCats[row][column]["value"];
					for (var catKey in cellCats[row][column]["cats"]) {
						newContents += "," + cellCats[row][column]["cats"][catKey];
					}
					grid.updateCellContents(row, column, newContents);
				}
				
				// remove from color legend cell reverse lookup
				delete catLegend[cat][label];
				
				// referesh category elements
				updateCategoryList();
			}
			
			// remove and cleanup references to cat and label
			function updateLabelName(cat, oldLabel, label) {	// should we allow for change of category also ??
				// update color legend cell reverse lookup				
				if (catLegend[cat][label] == null) {
					catLegend[cat][label] = {};
					catLegend[cat][label]["cellref"] = [];
					catLegend[cat][label] = catLegend[cat][oldLabel];

					// remove old label
					delete catLegend[cat][oldLabel];
					
					// referesh category elements
					updateCategoryList();
				} else {
					// other label already exists , can't rename on label to another existing label !!
					// throw exception or something !!!
					// ERROR!!
					console.log("stop it !");
				}
			}
			
			/**
             * This function changes the style of a particular cell
             */
            function addNewLabel() {
				//var selCells = grid.getSelectedCells();
				var selCells = highlightedCoords;
				console.log(selCells);
				var cat = document.getElementById("newCatValue").value;
				var label = document.getElementById("newLabelValue").value;
				var color = document.getElementById("newColorValue").value;
				
				// update catLegend color
				if (catLegend[cat] == null) {
					catLegend[cat] = {};
				}
				
				if (catLegend[cat][label] == null) {
					catLegend[cat][label] = {};
					catLegend[cat][label]['color'] = color;
				} else {
					catLegend[cat][label]['color'] = color;
					// category and label already exist, just changing color,
					// in this case cells which already have this label need their color updated also!!
					updateCellColors(cat, label, color);
				}
				
				// update selected grid cells with label
				for (var cell in selCells) {
					var row = selCells[cell][0];		// change iteration method !!!
					var column = selCells[cell][1];
					
					// messy hack	--> maybe not so bad for efficiency actually ?
					if (cellCats[row] == null) {
						cellCats[row] = [];
					}
					if (cellCats[row][column] == null) {
						cellCats[row][column] = [];
						cellCats[row][column]["cats"] = [];
					}
					
					cellCats[row][column]["value"] = data[row-1][column-1];
					cellCats[row][column]["cats"][cat] = color;
					var newContents = cellCats[row][column]["value"];

					for (var catKey in cellCats[row][column]["cats"]) {
						newContents += "," + cellCats[row][column]["cats"][catKey];
					}
					
					grid.updateCellContents(row,column, newContents);
					
					// update color legend cell reverse lookup
					if (catLegend[cat][label]["cellref"] == null) {
						catLegend[cat][label]["cellref"] = [];
						catLegend[cat][label]["cellref"].push(row + "-" + column);
					} else {
						if (catLegend[cat][label]["cellref"].indexOf(row + "-" + column) == -1) {
							catLegend[cat][label]["cellref"].push(row + "-" + column);
						} else {
							console.log("already there");
						}
					}
				}
				
				updateCategoryList();
				// disable selection of grid cells
				hideLabelPanel();
            }
			
			

            /**
             * addEvent - This function adds an event handler to an html element in
             * a way that covers many browser types.
             * @param elementId - the string id of the element to attach the handler to
             * or a reference to the element itself.
             * @param eventType - a string representation of the event to be handled
             * without the "on" prefix
             * @param handlerFunction - the function to handle the event
             */
            function addEvent(elementId, eventType, handlerFunction) {
                'use strict';

                var element;

                if (typeof(elementId) === "string"){
                    element = document.getElementById(elementId);
                } else {
                    element = elementId;
                }

                if (element.addEventListener) {
                    element.addEventListener(eventType, handlerFunction, false);
                } else if (window.attachEvent) {
                    element.attachEvent("on" + eventType, handlerFunction);
                }
            } // end of function addEvent


            /**
             * This function handles the window load event. It initializes and fills the
             * grid with blank data and sets up the event handlers on the
             */
            function init(){
                createGrid();
                loadRandomData();
				addEvent("addNewLabel", "click", addNewLabel);
				addEvent("cancelNewLabel", "click", cancelNewLabel);
				addEvent("clearLastSelection", "click", removeHighlightedArea);
				addEvent("clearAllSelection", "click", removeAllHighlightedCells);

				// initially disable selection of grid cells
				disableGridSelection();
            }

            window.onload = init;
			
			// jQuery ui stuff
			$(function() {
				$( "#tabs-1" ).tabs();
				
				$("#addLabelPanel").hide();
					
				$("#addLabelButton").click(function() {
					showLabelPanel();
				});
				
				$("#editLabelDialog").dialog({
					autoOpen: false,
					resizable: false,
					height:140,
					modal: true,
					buttons: {
						"Save New Name": function() {
							updateLabelName(tmpEditCat, tmpEditOldLabel, document.getElementById("editNewLabelValue").value);
							delete tmpEdit;
							delete tmpEditOldLabel;
							$(this).dialog("close");
						},
						Cancel: function() {
							delete tmpEdit;
							delete tmpEditOldLabel;
							$(this).dialog("close");
						}
					}
				});
			});
			
			function showLabelPanel() {
				enableGridSelection();
				$("#addLabelPanel").show("drop", {direction: "right"}, 500 );
			};
			
			function hideLabelPanel() {
				disableGridSelection();
				$("#addLabelPanel").hide("drop", {direction: "right"}, 500 );
			};
        </script>
    </body>
</html>